---
layout: post
title: "annotaterb v4.22.0 commit log æµã—èª­ã¿"
image: https://odentakashi.github.io/public/images/mini_annotaterb_schematic.png
date: 2026-02-15 12:01
---

annotaterb v4.22.0 commit logã‚’æµã—ã§èª­ã¿ã¾ã—ãŸ ğŸ‘€<br>
èª­ã‚“ã ã‚³ãƒŸãƒƒãƒˆã¯ä¸‹è¨˜ã§ã™ã€‚
- [Comparing v4\.21\.0\.\.\.v4\.22\.0 Â· drwl/annotaterb](https://github.com/drwl/annotaterb/compare/v4.21.0...v4.22.0)

## Run CI on CRuby 4.0 #308
CI ã«ã¦å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ãƒãƒˆãƒªã‚¯ã‚¹ã« Ruby 4.0 ã‚’è¿½åŠ ã—ã¦ã„ã¾ã™ã€‚<br>
Ruby 4.0 ã‹ã‚‰ `benchmark`, `ostruct` ãŒ bundled gem ã«å¤‰ã‚ã£ãŸãŸã‚ `Gemfile` ã«æ˜ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

refs: [Run CI on CRuby 4\.0\#308](https://github.com/drwl/annotaterb/pull/308)

## Use #lease_connection if available#292
`connection` ãŒåˆ©ç”¨ã•ã‚Œã¦ã„ã‚‹ç®‡æ‰€ã‚’ `lease_connection` ã‚’åˆ©ç”¨ã™ã‚‹ã‚ˆã†ã«ä¿®æ­£ã•ã‚Œã¦ã„ã¾ã™ã€‚

refs: [Use \#lease\_connection if available](https://github.com/drwl/annotaterb/pull/292)

## fix NoMethodError when using nested_position with fixture files#298
`nested-position` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’åˆ©ç”¨ã—ãŸéš›ã« `NoMethodError` ãŒç™ºç”Ÿã—ã¦ã„ã¾ã—ãŸã€‚åŸå› ã¯ã€YAML ãƒ•ã‚¡ã‚¤ãƒ«å°‚ç”¨ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ‘ãƒ¼ã‚µãƒ¼ã«å¯¾ã—ã¦å­˜åœ¨ã—ãªã„ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—ã¦ã„ãŸã“ã¨ã«ã‚ˆã‚‹ã‚‚ã®ã§ã™ã€‚

ã“ã®ã‚³ãƒŸãƒƒãƒˆã§ã¯ã€è©²å½“ç®‡æ‰€ã«é©åˆ‡ãªã‚¬ãƒ¼ãƒ‰å‡¦ç†ã‚’è¿½åŠ ã—ã€ãƒ¡ã‚½ãƒƒãƒ‰å‘¼ã³å‡ºã—ãŒè¡Œã‚ã‚Œãªã„ã‚ˆã†ä¿®æ­£ã—ã¦ã„ã¾ã™ã€‚

refs: [fix NoMethodError when using nested\_position with fixture files](https://github.com/drwl/annotaterb/pull/298)

## Honor skip_on_db_migrate config option when runnig migrate tasks#274
`skip_on_db_migrate` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æŒ‡å®šã—ã¦ã„ã¦ã‚‚ã€`migration` å®Ÿè¡Œæ™‚ã« `annotation` å‡¦ç†ãŒã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œãªã„çŠ¶æ…‹ã«ãªã£ã¦ã„ã¾ã—ãŸã€‚

ã“ã®ã‚³ãƒŸãƒƒãƒˆã§ã¯ã€å½“è©²ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒæœ‰åŠ¹ãªå ´åˆã« `migration` å®Ÿè¡Œæ™‚ã® `annotation` ã‚’å®Ÿè¡Œã—ãªã„ã‚ˆã†åˆ¶å¾¡ã‚’è¿½åŠ ã—ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®æŒ™å‹•ãŒæ­£ã—ãåæ˜ ã•ã‚Œã‚‹ã‚ˆã†ä¿®æ­£ã—ã¦ã„ã¾ã™ã€‚

refs: [Honor skip\_on\_db\_migrate config option when runnig migrate tasks](https://github.com/drwl/annotaterb/pull/274)

## fix: Respect configured sort#295
`classified_sort` ã‚„ `sort` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹å ´åˆã§ã‚‚ã€æ—¢å­˜ã® `annotation` ã«ãã®è¨­å®šãŒæ­£ã—ãåæ˜ ã•ã‚Œãªã„ã“ã¨ãŒã‚ã‚‹ä¸å…·åˆã®ä¿®æ­£ã§ã™ã€‚

å¾“æ¥ã®å®Ÿè£…ã§ã¯ã€æ—¢å­˜ã® `annotation` ã¨æ–°ã—ãç”Ÿæˆã—ãŸ `annotation` ã‚’æ¯”è¼ƒã™ã‚‹éš›ã«ã€ã©ã¡ã‚‰ã‚‚ `sort` ã—ã¦ã‹ã‚‰å·®åˆ†ã‚’è¨ˆç®—ã—ã¦ã„ã¾ã—ãŸã€‚ãã®ãŸã‚ã€å®Ÿéš›ã«ã¯ä¸¦ã³é †ãŒã‚ªãƒ—ã‚·ãƒ§ãƒ³é€šã‚Šã«ãªã£ã¦ã„ãªãã¦ã‚‚ã€æ¯”è¼ƒæ™‚ã«ã‚½ãƒ¼ãƒˆã•ã‚Œã¦ã—ã¾ã†ã“ã¨ã§ã€Œå·®åˆ†ãªã—ã€ã¨åˆ¤å®šã•ã‚Œã€`annotation` ãŒæ›´æ–°ã•ã‚Œãªã„çŠ¶æ…‹ã«ãªã£ã¦ã„ã¾ã—ãŸã€‚

```rb
def generate
  # Ignore the Schema version line because it changes with each migration
  current_annotations = @file_content.match(HEADER_PATTERN).to_s
  new_annotations = @annotation_block.match(HEADER_PATTERN).to_s

  current_annotation_columns = if current_annotations.present?
    current_annotations.scan(COLUMN_PATTERN).sort
  else
    []
  end

  new_annotation_columns = if new_annotations.present?
    new_annotations.scan(COLUMN_PATTERN).sort
  else
    []
  end

  _result = AnnotationDiff.new(current_annotation_columns, new_annotation_columns)
end
```

ä»Šå›ã®ä¿®æ­£ã§ã¯ã€ã“ã® `sort` ã‚’å‰Šé™¤ã—ã€ä¸¦ã³é †ã‚‚å«ã‚ã¦å·®åˆ†ã‚’åˆ¤å®šã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€`classified_sort` ã‚„ `sort` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã«ã‚‚ã‹ã‹ã‚ã‚‰ãšæ—¢å­˜ã® `annotation` ãŒè¨­å®šé€šã‚Šã§ãªã„å ´åˆã€æ­£ã—ãå·®åˆ†ãŒæ¤œå‡ºã•ã‚Œã€`annotation` ãŒä¸Šæ›¸ãã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

```rb
def generate
  # Ignore the Schema version line because it changes with each migration
  current_annotations = @file_content.match(HEADER_PATTERN).to_s
  new_annotations = @annotation_block.match(HEADER_PATTERN).to_s

  current_annotation_columns = if current_annotations.present?
    current_annotations.scan(COLUMN_PATTERN)
  else
    []
  end

  new_annotation_columns = if new_annotations.present?
    new_annotations.scan(COLUMN_PATTERN)
  else
    []
  end

  _result = AnnotationDiff.new(current_annotation_columns, new_annotation_columns)
end
```

refs: [fix: Respect configured sort](https://github.com/drwl/annotaterb/pull/295/changes)

## refactor: simplify primary key check logic (no functional changes)#285
ç‰¹å®šã‚«ãƒ©ãƒ ãŒ `FK` ã‹ã©ã†ã‹åˆ¤åˆ¥ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚è¤‡é›‘ãªæ¡ä»¶ã‚’ã‚·ãƒ³ãƒ—ãƒ«ã«ãªã‚‹ã‚ˆã†ã«ä¿®æ­£ã—ã¦ã„ã¾ã™ã€‚

refs: [refactor: simplify primary key check logic \(no functional changes\)](https://github.com/drwl/annotaterb/pull/285)
